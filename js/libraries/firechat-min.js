(function(){var Q=this,J=Q._,L=Array.prototype,Z=Object.prototype,H=Function.prototype,V=L.push,ad=L.slice,P=L.concat,S=Z.toString,ab=Z.hasOwnProperty,Y=Array.isArray,K=Object.keys,N=H.bind,W=function(a){return a instanceof W?a:this instanceof W?void (this._wrapped=a):new W(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=W),exports._=W):Q._=W,W.VERSION="1.7.0";var X=function(c,a,b){if(a===void 0){return c}switch(null==b?3:b){case 1:return function(d){return c.call(a,d)};case 2:return function(d,f){return c.call(a,d,f)};case 3:return function(f,g,d){return c.call(a,f,g,d)};case 4:return function(g,h,d,f){return c.call(a,g,h,d,f)}}return function(){return c.apply(a,arguments)}};W.iteratee=function(c,a,b){return null==c?W.identity:W.isFunction(c)?X(c,a,b):W.isObject(c)?W.matches(c):W.property(c)},W.each=W.forEach=function(g,c,d){if(null==g){return g}c=X(c,d);var f,a=g.length;if(a===+a){for(f=0;a>f;f++){c(g[f],f,g)}}else{var b=W.keys(g);for(f=0,a=b.length;a>f;f++){c(g[b[f]],b[f],g)}}return g},W.map=W.collect=function(k,f,g){if(null==k){return[]}f=W.iteratee(f,g);for(var h,c=k.length!==+k.length&&W.keys(k),d=(c||k).length,b=Array(d),j=0;d>j;j++){h=c?c[j]:j,b[j]=f(k[h],h,k)}return b};var D="Reduce of empty array with no initial value";W.reduce=W.foldl=W.inject=function(k,f,g,h){null==k&&(k=[]),f=X(f,h,4);var c,d=k.length!==+k.length&&W.keys(k),b=(d||k).length,j=0;if(arguments.length<3){if(!b){throw new TypeError(D)}g=k[d?d[j++]:j++]}for(;b>j;j++){c=d?d[j]:j,g=f(g,k[c],c,k)}return g},W.reduceRight=W.foldr=function(j,f,g,h){null==j&&(j=[]),f=X(f,h,4);var c,d=j.length!==+j.length&&W.keys(j),b=(d||j).length;if(arguments.length<3){if(!b){throw new TypeError(D)}g=j[d?d[--b]:--b]}for(;b--;){c=d?d[b]:b,g=f(g,j[c],c,j)}return g},W.find=W.detect=function(d,a,b){var c;return a=W.iteratee(a,b),W.some(d,function(g,f,e){return a(g,f,e)?(c=g,!0):void 0}),c},W.filter=W.select=function(d,a,b){var c=[];return null==d?c:(a=W.iteratee(a,b),W.each(d,function(g,f,e){a(g,f,e)&&c.push(g)}),c)},W.reject=function(c,a,b){return W.filter(c,W.negate(W.iteratee(a)),b)},W.every=W.all=function(j,f,g){if(null==j){return !0}f=W.iteratee(f,g);var h,c,d=j.length!==+j.length&&W.keys(j),b=(d||j).length;for(h=0;b>h;h++){if(c=d?d[h]:h,!f(j[c],c,j)){return !1}}return !0},W.some=W.any=function(j,f,g){if(null==j){return !1}f=W.iteratee(f,g);var h,c,d=j.length!==+j.length&&W.keys(j),b=(d||j).length;for(h=0;b>h;h++){if(c=d?d[h]:h,f(j[c],c,j)){return !0}}return !1},W.contains=W.include=function(b,a){return null==b?!1:(b.length!==+b.length&&(b=W.values(b)),W.indexOf(b,a)>=0)},W.invoke=function(d,a){var b=ad.call(arguments,2),c=W.isFunction(a);return W.map(d,function(e){return(c?a:e[a]).apply(e,b)})},W.pluck=function(b,a){return W.map(b,W.property(a))},W.where=function(b,a){return W.filter(b,W.matches(a))},W.findWhere=function(b,a){return W.find(b,W.matches(a))},W.max=function(d,m,b){var h,k,g=-1/0,j=-1/0;if(null==m&&null!=d){d=d.length===+d.length?d:W.values(d);for(var c=0,f=d.length;f>c;c++){h=d[c],h>g&&(g=h)}}else{m=W.iteratee(m,b),W.each(d,function(l,a,i){k=m(l,a,i),(k>j||k===-1/0&&g===-1/0)&&(g=l,j=k)})}return g},W.min=function(d,m,b){var h,k,g=1/0,j=1/0;if(null==m&&null!=d){d=d.length===+d.length?d:W.values(d);for(var c=0,f=d.length;f>c;c++){h=d[c],g>h&&(g=h)}}else{m=W.iteratee(m,b),W.each(d,function(l,a,i){k=m(l,a,i),(j>k||1/0===k&&1/0===g)&&(g=l,j=k)})}return g},W.shuffle=function(g){for(var c,d=g&&g.length===+g.length?g:W.values(g),f=d.length,a=Array(f),b=0;f>b;b++){c=W.random(0,b),c!==b&&(a[b]=a[c]),a[c]=d[b]}return a},W.sample=function(c,a,b){return null==a||b?(c.length!==+c.length&&(c=W.values(c)),c[W.random(c.length-1)]):W.shuffle(c).slice(0,Math.max(0,a))},W.sortBy=function(c,a,b){return a=W.iteratee(a,b),W.pluck(W.map(c,function(g,d,f){return{value:g,index:d,criteria:a(g,d,f)}}).sort(function(h,d){var f=h.criteria,g=d.criteria;if(f!==g){if(f>g||f===void 0){return 1}if(g>f||g===void 0){return -1}}return h.index-d.index}),"value")};var R=function(a){return function(c,d,f){var b={};return d=W.iteratee(d,f),W.each(c,function(j,h){var g=d(j,h,c);a(b,j,g)}),b}};W.groupBy=R(function(c,a,b){W.has(c,b)?c[b].push(a):c[b]=[a]}),W.indexBy=R(function(c,a,b){c[b]=a}),W.countBy=R(function(c,a,b){W.has(c,b)?c[b]++:c[b]=1}),W.sortedIndex=function(k,f,g,h){g=W.iteratee(g,h,1);for(var c=g(f),d=0,b=k.length;b>d;){var j=d+b>>>1;g(k[j])<c?d=j+1:b=j}return d},W.toArray=function(a){return a?W.isArray(a)?ad.call(a):a.length===+a.length?W.map(a,W.identity):W.values(a):[]},W.size=function(a){return null==a?0:a.length===+a.length?a.length:W.keys(a).length},W.partition=function(f,b,c){b=W.iteratee(b,c);var d=[],a=[];return W.each(f,function(h,g,e){(b(h,g,e)?d:a).push(h)}),[d,a]},W.first=W.head=W.take=function(c,a,b){return null==c?void 0:null==a||b?c[0]:0>a?[]:ad.call(c,0,a)},W.initial=function(c,a,b){return ad.call(c,0,Math.max(0,c.length-(null==a||b?1:a)))},W.last=function(c,a,b){return null==c?void 0:null==a||b?c[c.length-1]:ad.call(c,Math.max(c.length-a,0))},W.rest=W.tail=W.drop=function(c,a,b){return ad.call(c,null==a||b?1:a)},W.compact=function(a){return W.filter(a,W.identity)};var z=function(i,f,g,h){if(f&&W.every(i,W.isArray)){return P.apply(h,i)}for(var d=0,c=i.length;c>d;d++){var b=i[d];W.isArray(b)||W.isArguments(b)?f?V.apply(h,b):z(b,f,g,h):g||h.push(b)}return h};W.flatten=function(b,a){return z(b,a,!1,[])},W.without=function(a){return W.difference(a,ad.call(arguments,1))},W.uniq=W.unique=function(f,s,b,j){if(null==f){return[]}W.isBoolean(s)||(j=b,b=s,s=!1),null!=b&&(b=W.iteratee(b,j));for(var p=[],h=[],m=0,d=f.length;d>m;m++){var g=f[m];if(s){m&&h===g||p.push(g),h=g}else{if(b){var k=b(g,m,f);W.indexOf(h,k)<0&&(h.push(k),p.push(g))}else{W.indexOf(p,g)<0&&p.push(g)}}}return p},W.union=function(){return W.uniq(z(arguments,!0,!0,[]))},W.intersection=function(j){if(null==j){return[]}for(var f=[],g=arguments.length,h=0,c=j.length;c>h;h++){var d=j[h];if(!W.contains(f,d)){for(var b=1;g>b&&W.contains(arguments[b],d);b++){}b===g&&f.push(d)}}return f},W.difference=function(b){var a=z(ad.call(arguments,1),!0,!0,[]);return W.filter(b,function(c){return !W.contains(a,c)})},W.zip=function(d){if(null==d){return[]}for(var a=W.max(arguments,"length").length,b=Array(a),c=0;a>c;c++){b[c]=W.pluck(arguments,c)}return b},W.object=function(f,b){if(null==f){return{}}for(var c={},d=0,a=f.length;a>d;d++){b?c[f[d]]=b[d]:c[f[d][0]]=f[d][1]}return c},W.indexOf=function(f,b,c){if(null==f){return -1}var d=0,a=f.length;if(c){if("number"!=typeof c){return d=W.sortedIndex(f,b),f[d]===b?d:-1}d=0>c?Math.max(0,a+c):c}for(;a>d;d++){if(f[d]===b){return d}}return -1},W.lastIndexOf=function(d,a,b){if(null==d){return -1}var c=d.length;for("number"==typeof b&&(c=0>b?c+b+1:Math.min(c,b+1));--c>=0;){if(d[c]===a){return c}}return -1},W.range=function(g,c,d){arguments.length<=1&&(c=g||0,g=0),d=d||1;for(var f=Math.max(Math.ceil((c-g)/d),0),a=Array(f),b=0;f>b;b++,g+=d){a[b]=g}return a};var aa=function(){};W.bind=function(d,a){var b,c;if(N&&d.bind===N){return N.apply(d,ad.call(arguments,1))}if(!W.isFunction(d)){throw new TypeError("Bind must be called on a function")}return b=ad.call(arguments,2),c=function(){if(!(this instanceof c)){return d.apply(a,b.concat(ad.call(arguments)))}aa.prototype=d.prototype;var e=new aa;aa.prototype=null;var f=d.apply(e,b.concat(ad.call(arguments)));return W.isObject(f)?f:e}},W.partial=function(b){var a=ad.call(arguments,1);return function(){for(var f=0,g=a.slice(),c=0,d=g.length;d>c;c++){g[c]===W&&(g[c]=arguments[f++])}for(;f<arguments.length;){g.push(arguments[f++])}return b.apply(this,g)}},W.bindAll=function(d){var a,b,c=arguments.length;if(1>=c){throw new Error("bindAll must be passed function names")}for(a=1;c>a;a++){b=arguments[a],d[b]=W.bind(d[b],d)}return d},W.memoize=function(c,a){var b=function(g){var d=b.cache,f=a?a.apply(this,arguments):g;return W.has(d,f)||(d[f]=c.apply(this,arguments)),d[f]};return b.cache={},b},W.delay=function(c,a){var b=ad.call(arguments,2);return setTimeout(function(){return c.apply(null,b)},a)},W.defer=function(a){return W.delay.apply(W,[a,1].concat(ad.call(arguments,1)))},W.throttle=function(d,m,b){var h,k,g,j=null,c=0;b||(b={});var f=function(){c=b.leading===!1?0:W.now(),j=null,g=d.apply(h,k),j||(h=k=null)};return function(){var e=W.now();c||b.leading!==!1||(c=e);var a=m-(e-c);return h=this,k=arguments,0>=a||a>m?(clearTimeout(j),j=null,c=e,g=d.apply(h,k),j||(h=k=null)):j||b.trailing===!1||(j=setTimeout(f,a)),g}},W.debounce=function(d,m,b){var h,k,g,j,c,f=function(){var a=W.now()-j;m>a&&a>0?h=setTimeout(f,m-a):(h=null,b||(c=d.apply(g,k),h||(g=k=null)))};return function(){g=this,k=arguments,j=W.now();var a=b&&!h;return h||(h=setTimeout(f,m)),a&&(c=d.apply(g,k),g=k=null),c}},W.wrap=function(b,a){return W.partial(a,b)},W.negate=function(a){return function(){return !a.apply(this,arguments)}},W.compose=function(){var b=arguments,a=b.length-1;return function(){for(var c=a,d=b[a].apply(this,arguments);c--;){d=b[c].call(this,d)}return d}},W.after=function(b,a){return function(){return --b<1?a.apply(this,arguments):void 0}},W.before=function(c,a){var b;return function(){return --c>0?b=a.apply(this,arguments):a=null,b}},W.once=W.partial(W.before,2),W.keys=function(c){if(!W.isObject(c)){return[]}if(K){return K(c)}var a=[];for(var b in c){W.has(c,b)&&a.push(b)}return a},W.values=function(f){for(var b=W.keys(f),c=b.length,d=Array(c),a=0;c>a;a++){d[a]=f[b[a]]}return d},W.pairs=function(f){for(var b=W.keys(f),c=b.length,d=Array(c),a=0;c>a;a++){d[a]=[b[a],f[b[a]]]}return d},W.invert=function(f){for(var b={},c=W.keys(f),d=0,a=c.length;a>d;d++){b[f[c[d]]]=c[d]}return b},W.functions=W.methods=function(c){var a=[];for(var b in c){W.isFunction(c[b])&&a.push(b)}return a.sort()},W.extend=function(f){if(!W.isObject(f)){return f}for(var b,c,d=1,a=arguments.length;a>d;d++){b=arguments[d];for(c in b){ab.call(b,c)&&(f[c]=b[c])}}return f},W.pick=function(b,o,a){var j,m={};if(null==b){return m}if(W.isFunction(o)){o=X(o,a);for(j in b){var g=b[j];o(g,j,b)&&(m[j]=g)}}else{var d=P.apply([],ad.call(arguments,1));b=new Object(b);for(var k=0,h=d.length;h>k;k++){j=d[k],j in b&&(m[j]=b[j])}}return m},W.omit=function(d,a,b){if(W.isFunction(a)){a=W.negate(a)}else{var c=W.map(P.apply([],ad.call(arguments,1)),String);a=function(f,e){return !W.contains(c,e)}}return W.pick(d,a,b)},W.defaults=function(f){if(!W.isObject(f)){return f}for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];for(var a in d){f[a]===void 0&&(f[a]=d[a])}}return f},W.clone=function(a){return W.isObject(a)?W.isArray(a)?a.slice():W.extend({},a):a},W.tap=function(b,a){return a(b),b};var ac=function(h,x,b,l){if(h===x){return 0!==h||1/h===1/x}if(null==h||null==x){return h===x}h instanceof W&&(h=h._wrapped),x instanceof W&&(x=x._wrapped);var w=S.call(h);if(w!==S.call(x)){return !1}switch(w){case"[object RegExp]":case"[object String]":return""+h==""+x;case"[object Number]":return +h!==+h?+x!==+x:0===+h?1/+h===1/x:+h===+x;case"[object Date]":case"[object Boolean]":return +h===+x}if("object"!=typeof h||"object"!=typeof x){return !1}for(var j=b.length;j--;){if(b[j]===h){return l[j]===x}}var v=h.constructor,g=x.constructor;if(v!==g&&"constructor" in h&&"constructor" in x&&!(W.isFunction(v)&&v instanceof v&&W.isFunction(g)&&g instanceof g)){return !1}b.push(h),l.push(x);var m,k;if("[object Array]"===w){if(m=h.length,k=m===x.length){for(;m--&&(k=ac(h[m],x[m],b,l));){}}}else{var y,d=W.keys(h);if(m=d.length,k=W.keys(x).length===m){for(;m--&&(y=d[m],k=W.has(x,y)&&ac(h[y],x[y],b,l));){}}}return b.pop(),l.pop(),k};W.isEqual=function(b,a){return ac(b,a,[],[])},W.isEmpty=function(b){if(null==b){return !0}if(W.isArray(b)||W.isString(b)||W.isArguments(b)){return 0===b.length}for(var a in b){if(W.has(b,a)){return !1}}return !0},W.isElement=function(a){return !(!a||1!==a.nodeType)},W.isArray=Y||function(a){return"[object Array]"===S.call(a)},W.isObject=function(b){var a=typeof b;return"function"===a||"object"===a&&!!b},W.each(["Arguments","Function","String","Number","Date","RegExp"],function(a){W["is"+a]=function(b){return S.call(b)==="[object "+a+"]"}}),W.isArguments(arguments)||(W.isArguments=function(a){return W.has(a,"callee")}),"function"!=typeof/./&&(W.isFunction=function(a){return"function"==typeof a||!1}),W.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},W.isNaN=function(a){return W.isNumber(a)&&a!==+a},W.isBoolean=function(a){return a===!0||a===!1||"[object Boolean]"===S.call(a)},W.isNull=function(a){return null===a},W.isUndefined=function(a){return a===void 0},W.has=function(b,a){return null!=b&&ab.call(b,a)},W.noConflict=function(){return Q._=J,this},W.identity=function(a){return a},W.constant=function(a){return function(){return a}},W.noop=function(){},W.property=function(a){return function(b){return b[a]}},W.matches=function(c){var a=W.pairs(c),b=a.length;return function(h){if(null==h){return !b}h=new Object(h);for(var g=0;b>g;g++){var d=a[g],f=d[0];if(d[1]!==h[f]||!(f in h)){return !1}}return !0}},W.times=function(f,b,c){var d=Array(Math.max(0,f));b=X(b,c,1);for(var a=0;f>a;a++){d[a]=b(a)}return d},W.random=function(b,a){return null==a&&(a=b,b=0),b+Math.floor(Math.random()*(a-b+1))},W.now=Date.now||function(){return(new Date).getTime()};var ae={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},C=W.invert(ae),U=function(f){var b=function(e){return f[e]},c="(?:"+W.keys(f).join("|")+")",d=RegExp(c),a=RegExp(c,"g");return function(e){return e=null==e?"":""+e,d.test(e)?e.replace(a,b):e}};W.escape=U(ae),W.unescape=U(C),W.result=function(c,a){if(null==c){return void 0}var b=c[a];return W.isFunction(b)?c[a]():b};var B=0;W.uniqueId=function(b){var a=++B+"";return b?b+a:a},W.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var M=/(.)^/,T={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},q=/\\|'|\r|\n|\u2028|\u2029/g,G=function(a){return"\\"+T[a]};W.template=function(f,s,b){!s&&b&&(s=b),s=W.defaults({},s,W.templateSettings);var j=RegExp([(s.escape||M).source,(s.interpolate||M).source,(s.evaluate||M).source].join("|")+"|$","g"),p=0,h="__p+='";f.replace(j,function(i,l,n,c,u){return h+=f.slice(p,u).replace(q,G),p=u+i.length,l?h+="'+\n((__t=("+l+"))==null?'':_.escape(__t))+\n'":n?h+="'+\n((__t=("+n+"))==null?'':__t)+\n'":c&&(h+="';\n"+c+"\n__p+='"),i}),h+="';\n",s.variable||(h="with(obj||{}){\n"+h+"}\n"),h="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+h+"return __p;\n";try{var m=new Function(s.variable||"obj","_",h)}catch(d){throw d.source=h,d}var g=function(a){return m.call(this,a,W)},k=s.variable||"obj";return g.source="function("+k+"){\n"+h+"}",g},W.chain=function(b){var a=W(b);return a._chain=!0,a};var I=function(a){return this._chain?W(a).chain():a};W.mixin=function(a){W.each(W.functions(a),function(b){var c=W[b]=a[b];W.prototype[b]=function(){var d=[this._wrapped];return V.apply(d,arguments),I.call(this,c.apply(W,d))}})},W.mixin(W),W.each(["pop","push","reverse","shift","sort","splice","unshift"],function(b){var a=L[b];W.prototype[b]=function(){var c=this._wrapped;return a.apply(c,arguments),"shift"!==b&&"splice"!==b||0!==c.length||delete c[0],I.call(this,c)}}),W.each(["concat","join","slice"],function(b){var a=L[b];W.prototype[b]=function(){return I.call(this,a.apply(this._wrapped,arguments))}}),W.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return W})}).call(this);this["FirechatDefaultTemplates"]=this["FirechatDefaultTemplates"]||{};this["FirechatDefaultTemplates"]["templates/layout-full.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div id='firechat' class='full'>\n<div id='firechat-header' class='clearfix'>\n<div class='clearfix'><div class='half firechat-dropdown' style=''>\n<a id='firechat-btn-rooms' class='firechat-dropdown-toggle btn full' data-toggle=\"firechat-dropdown\" href='#'>\n<span class='icon user-chat'></span>\nChat Rooms\n<span class='caret'></span>\n</a>\n<div class='firechat-dropdown-menu full' role='menu'><ul id='firechat-room-list'></ul><div class='firechat-dropdown-footer aligncenter'>\n<button type='button' class='btn twothird center' id='firechat-btn-create-room-prompt'>Create Room</button>\n</div></div></div>\n<div class='half firechat-dropdown' style=''>\n<a data-event='firechat-user-search-btn' class='btn full firechat-dropdown-toggle' data-toggle=\"firechat-dropdown\" href='#'>\n<span class='icon user-group'></span>\nVisitors\n<span class='caret'></span>\n</a>\n<div class='firechat-dropdown-menu' role='menu'>\n<div class='firechat-dropdown-header aligncenter clearfix'>\n<div class='search-wrapper'>\n<span class='icon search'></span>\n<input type='text' data-event='firechat-user-search' data-template='templates/user-search-list-item.html' data-target='firechat-user-search' data-controls='firechat-user-search-controls' class='center fivesixth'>\n</div>\n</div>\n<ul id='firechat-user-search'></ul><div class='firechat-dropdown-footer aligncenter clearfix'>\n<div id='firechat-user-search-controls' class='clearfix'>\n<span class=\"quarter\"></span>\n<button type='button' class='btn half' data-event='firechat-user-search' data-toggle='firechat-pagination-next' data-template='templates/user-search-list-item.html' data-target='firechat-user-search' data-controls='firechat-user-search-controls' disabled=disabled>Next</button>\n</div><label class='center full'>\n<small>Use \"+ Invite\" button within chat rooms for regular invites.</small>\n</label>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div id='firechat-tabs' class='clearfix'>\n<ul id='firechat-tab-list' class='nav nav-tabs clearfix'></ul>\n<div id='firechat-tab-content' class='tab-content'></div>\n</div><div id='firechat-footer' class='clearfix'></div>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/layout-popout.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div id='firechat' class='full'>\n<div id='firechat-tabs' class='clearfix'>\n<ul id='firechat-tab-list' class='nav nav-tabs clearfix'></ul>\n<div id='firechat-tab-content' class='tab-content'></div>\n</div>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/message-context-menu.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<div data-toggle='firechat-contextmenu' class='contextmenu' data-message-id='"+__e(id)+"'>\n<ul>\n<li><a href='#!' data-event='firechat-user-warn'>Warn User</a></li>\n";if(allowKick){__p+="\n<li><a href='#!' data-event='firechat-user-kick'>Kick User</a></li>\n"}__p+="\n<li><a href='#!' data-event='firechat-user-suspend-hour'>Suspend User (1 Hour)</a></li>\n<li><a href='#!' data-event='firechat-user-suspend-day'>Suspend User (1 Day)</a></li>\n<li><a href='#!' data-event='firechat-message-delete'>Delete Message</a></li>\n</ul>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/message.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<div class='message message-"+__e(type)+" ";if(isSelfMessage){__p+=" message-self "}__p+="' data-message-id='"+__e(id)+"' data-user-id='"+__e(userId)+"' data-user-name='"+__e(name)+"' data-class=\"firechat-message\">\n<div class='clearfix'>\n<label class='fourfifth'>\n<strong class='name' title='"+__e(name)+"'>"+__e(name)+"</strong>\n<em>("+__e(localtime)+")</em>:\n</label>";if(!disableActions){__p+="\n<label class='fifth alignright'>\n<a href='#!' data-event='firechat-user-chat' class='icon user-chat' title='Invite to Private Chat'>&nbsp;</a>\n<a href='#!' data-event='firechat-user-mute-toggle' class='icon user-mute' title='Mute User'>&nbsp;</a>\n</label>\n"}__p+="</div>\n<div class='clearfix message-content'>\n"+((__t=(message))==null?"":__t)+"\n</div>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt-alert.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div class='aligncenter clearfix'>\n<h6>"+__e(message)+"</h6>\n<p class='clearfix'>\n<button type='button' class='btn quarter right close'>Close</button>\n</p>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt-create-room.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div class='clearfix'>\n<h6>Give your chat room a name:</h6>\n<input data-input='firechat-room-name' type='text' placeholder='Room name...' style='margin-bottom: 5px;' maxlength='"+__e(maxLengthRoomName)+"'>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt-invitation.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div class='aligncenter clearfix'>\n<h5>"+__e(fromUserName)+"</h5>\n<p>invited you to join</p>\n<h5>"+__e(toRoomName)+"</h5>\n<p class='clearfix'>\n<button data-toggle='accept' type='button' class='btn'>Accept</button>\n<button data-toggle='decline' type='button' class='btn'>Decline</button>\n</p>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt-invite-private.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div class='aligncenter clearfix'>\n<h6>Invite <strong>"+__e(userName)+"</strong> to "+__e(roomName)+"?</h6>\n<p class='clearfix'>\n<button data-toggle='accept' type='button' class='btn'>Invite</button>\n<button data-toggle='decline' type='button' class='close btn'>Cancel</button>\n</p>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt-invite-reply.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<div class='aligncenter clearfix'>\n<h5>"+__e(toUserName)+"</h5>\n<p>\n";if(status==="accepted"){__p+=" accepted your invite. "}else{__p+=" declined your invite. "}__p+="\n</p>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt-user-mute.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div class='aligncenter clearfix'>\n<h5>"+__e(userName)+"</h5>\n<p class='clearfix'>\n<button data-toggle='accept' type='button' class='btn'>Mute</button>\n<button data-toggle='decline' type='button' class='btn'>Cancel</button>\n</p>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/prompt.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div class='prompt hidden'>\n<div class='prompt-header'>\n"+__e(title)+"\n<a href='#!' class='close right'>X</a>\n</div>\n<div class='prompt-body clearfix'>\n"+((__t=(content))==null?"":__t)+"\n</div>\n<div class='prompt-footer'></div>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/room-list-item.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<li data-room-type='"+__e(type)+"' data-room-id='"+__e(id)+"' data-room-name='"+__e(name)+"'>\n<a href='#!' class='clearfix ";if(isRoomOpen){__p+=" highlight "}__p+="'>\n<span class='left' title='"+__e(name)+"'>"+__e(name)+"</span>\n</a>\n</li>"}return __p};this["FirechatDefaultTemplates"]["templates/room-user-list-item.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<li data-user-id='"+__e(id)+"' data-user-name='"+__e(name)+"'>\n<a href='#!' class='clearfix'>\n<span class='left twothird clipped' title='"+__e(name)+"'>"+__e(name)+"</span>";if(!disableActions){__p+="\n<span data-event='firechat-user-mute-toggle' class='icon user-mute right ";if(isMuted){__p+=" red "}__p+="' title='Toggle User Mute'>&nbsp;</span>\n<span data-event='firechat-user-chat' class='icon user-chat right' title='Invite to Private Chat'>&nbsp;</span>\n"}__p+="\n</a>\n</li>"}return __p};this["FirechatDefaultTemplates"]["templates/room-user-search-list-item.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<li data-user-id='"+__e(id)+"' data-user-name='"+__e(name)+"'>\n<a href='#!' class='clearfix'>\n";if(disableActions){__p+="\n<span class='left fourfifth clipped' title='"+__e(name)+"'>"+__e(name)+"</span>\n"}else{__p+="\n<span data-event='firechat-user-invite' class='left fourfifth clipped' title='"+__e(name)+"'>"+__e(name)+"</span>\n<span data-event='firechat-user-invite' class='icon plus right' title='Invite to Room'>+</span>\n"}__p+="\n</a>\n</li>"}return __p};this["FirechatDefaultTemplates"]["templates/tab-content.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<div id='"+__e(id)+"' data-room-id='"+__e(id)+"' class='tab-pane'>\n<div class='tab-pane-menu clearfix'><div class='firechat-dropdown twofifth'>\n<a data-event='firechat-user-room-list-btn' class='full btn firechat-dropdown-toggle' data-toggle=\"firechat-dropdown\" href='#' data-target='firechat-room-user-list-"+__e(id)+"'>\n<span class='icon user-group'></span>\nIn Room\n<span class='caret'></span>\n</a>\n<div class='firechat-dropdown-menu' role='menu'>\n<ul id='firechat-room-user-list-"+__e(id)+"' class='full'></ul>\n</div>\n</div><div class='firechat-dropdown twofifth'>\n<a data-event='firechat-user-search-btn' class='full btn firechat-dropdown-toggle' data-toggle=\"firechat-dropdown\" href='#'>\n<span class='icon plus'>+</span>\nInvite\n<span class='caret'></span>\n</a><div class='firechat-dropdown-menu' role='menu'>\n<div class='firechat-dropdown-header aligncenter clearfix'>\n<div class='search-wrapper'>\n<span class='icon search'></span>\n<input type='text' data-event='firechat-user-search' data-template='templates/room-user-search-list-item.html' data-target='firechat-room-user-search-"+__e(id)+"' data-controls='firechat-room-user-search-controls-"+__e(id)+"' class='center fivesixth'>\n</div>\n</div>\n<ul id='firechat-room-user-search-"+__e(id)+"'></ul><div class='firechat-dropdown-footer aligncenter clearfix'>\n<div id='firechat-room-user-search-controls-"+__e(id)+"' class='clearfix'><span class=\"quarter\"></span>\n<!--\n<button type='button' class='btn third disabled' data-event='firechat-user-search' data-template='templates/room-user-search-list-item.html' data-target='firechat-room-user-search-"+__e(id)+"' data-controls='firechat-room-user-search-controls-"+__e(id)+"' data-toggle='firechat-pagination-prev' disabled=disabled>Prev</button>\n-->\n<button type='button' class='btn half disabled' data-event='firechat-user-search' data-template='templates/room-user-search-list-item.html' data-target='firechat-room-user-search-"+__e(id)+"' data-controls='firechat-room-user-search-controls-"+__e(id)+"' data-toggle='firechat-pagination-next'  disabled=disabled>Next</button>\n</div>\n</div>\n</div>\n</div><a href='#!' data-event='firechat-close-tab' class='icon close right' style='15px 5px' title='Leave Room'></a></div><div class='clearfix'>\n<div id='firechat-messages"+__e(id)+"' class='chat'></div>\n</div><div class='clearfix'>\n<label>Your message:</label>\n<textarea id='textarea"+__e(id)+"' placeholder='Type your message here...'></textarea>\n</div>\n</div>"}return __p};this["FirechatDefaultTemplates"]["templates/tab-menu-item.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj){__p+="<li data-room-id='"+__e(id)+"'>\n<a href='#"+__e(id)+"' data-toggle='firechat-tab' title='"+__e(name)+"'>"+__e(name)+"</a>\n</li>"}return __p};this["FirechatDefaultTemplates"]["templates/user-search-list-item.html"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;function print(){__p+=__j.call(arguments,"")}with(obj){__p+="<li data-user-id='"+__e(id)+"' data-user-name='"+__e(name)+"'>\n<a href='#!' class='clearfix'>\n";if(disableActions){__p+="\n<span class='left fivesixth clipped' title='"+__e(name)+"'>"+__e(name)+"</span>\n"}else{__p+="\n<span data-event='firechat-user-chat' class='left fivesixth clipped' title='"+__e(name)+"'>"+__e(name)+"</span>\n<span data-event='firechat-user-chat' class='icon user-chat right' title='Invite to Private Chat'>&nbsp;</span>\n"}__p+="\n</a>\n</li>"}return __p};(function(a){if(!Function.prototype.bind){Function.prototype.bind=function(b){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var f=Array.prototype.slice.call(arguments,1),e=this,c=function(){},d=function(){return e.apply(this instanceof c&&b?this:b,f.concat(Array.prototype.slice.call(arguments)))};c.prototype=this.prototype;d.prototype=new c();return d}}Object.keys=Object.keys||function(c){var b=[];for(var d in c){if(c.hasOwnProperty(d)){b.push(d)}}return b}})();(function(c){var b=this,e=b.Firechat;function d(g,f){this._firebase=g;this._user=null;this._userId=null;this._userName=null;this._isModerator=false;this._sessionId=null;this._events={};this._rooms={};this._presenceBits={};this._userRef=null;this._messageRef=this._firebase.child("room-messages");this._roomRef=this._firebase.child("room-metadata");this._privateRoomRef=this._firebase.child("room-private-metadata");this._moderatorsRef=this._firebase.child("moderators");this._suspensionsRef=this._firebase.child("suspensions");this._usersOnlineRef=this._firebase.child("user-names-online");this._options=f||{};this._options.numMaxMessages=this._options.numMaxMessages||50}d.noConflict=function a(){b.Firechat=e;return d};b.Firechat=d;d.prototype={_loadUserMetadata:function(g){var f=this;this._userRef.transaction(function(h){if(!h||!h.id||!h.name){return{id:f._userId,name:f._userName}}},function(j,h,i){f._user=i.val();f._moderatorsRef.child(f._userId).once("value",function(k){f._isModerator=!!k.val();b.setTimeout(g,0)})})},_setupDataEvents:function(){this._firebase.root().child(".info/connected").on("value",function(j){if(j.val()===true){for(var k=0;k<this._presenceBits;k++){var m=this._presenceBits[k],l=this._firebase.root().child(m.ref);l.onDisconnect().set(m.offlineValue);l.set(m.onlineValue)}}},this);var g=this._userRef.child("sessions").push();this._sessionId=g.key();this._queuePresenceOperation(g,true,null);var h=this._usersOnlineRef.child(this._userName.toLowerCase());var f=h.child(this._sessionId);this._queuePresenceOperation(f,{id:this._userId,name:this._userName},null);this._userRef.on("value",this._onUpdateUser,this);this._userRef.child("invites").on("child_added",this._onFirechatInvite,this);this._userRef.child("notifications").on("child_added",this._onNotification,this)},_addEventCallback:function(f,g){this._events[f]=this._events[f]||[];this._events[f].push(g)},_getEventCallbacks:function(f){if(this._events.hasOwnProperty(f)){return this._events[f]}return[]},_invokeEventCallbacks:function(h){var f=[],j=this._getEventCallbacks(h);Array.prototype.push.apply(f,arguments);f=f.slice(1);for(var g=0;g<j.length;g+=1){j[g].apply(null,f)}},_queuePresenceOperation:function(g,h,f){g.onDisconnect().set(f);g.set(h);this._presenceBits[g.toString()]={ref:g,onlineValue:h,offlineValue:f}},_removePresenceOperation:function(h,g){var f=new c(h);f.onDisconnect().cancel();f.set(g);delete this._presenceBits[h]},_onUpdateUser:function(f){this._user=f.val();this._invokeEventCallbacks("user-update",this._user)},_onAuthRequired:function(){this._invokeEventCallbacks("auth-required")},_onEnterRoom:function(f){this._invokeEventCallbacks("room-enter",f)},_onNewMessage:function(h,f){var g=f.val();g.id=f.key();this._invokeEventCallbacks("message-add",h,g)},_onRemoveMessage:function(h,f){var g=f.key();this._invokeEventCallbacks("message-remove",h,g)},_onLeaveRoom:function(f){this._invokeEventCallbacks("room-exit",f)},_onNotification:function(f){var g=f.val();if(!g.read){if(g.notificationType!=="suspension"||g.data.suspendedUntil<new Date().getTime()){f.ref().child("read").set(true)}this._invokeEventCallbacks("notification",g)}},_onFirechatInvite:function(h){var g=this,f=h.val();if(f.status){return}f.id=f.id||h.key();g.getRoom(f.roomId,function(i){f.toRoomName=i.name;g._invokeEventCallbacks("room-invite",f)})},_onFirechatInviteResponse:function(h){var g=this,f=h.val();f.id=f.id||h.key();this._invokeEventCallbacks("room-invite-response",f)}};d.prototype.setUser=function(g,h,i){var f=this;f._firebase.onAuth(function(j){if(j){f._userId=g.toString();f._userName=h.toString();f._userRef=f._firebase.child("users").child(f._userId);f._loadUserMetadata(function(){b.setTimeout(function(){i(f._user);f._setupDataEvents()},0)})}else{f.warn("Firechat requires an authenticated Firebase reference. Pass an authenticated reference before loading.")}})};d.prototype.resumeSession=function(){this._userRef.child("rooms").once("value",function(f){var h=f.val();for(var g in h){this.enterRoom(h[g].id)}},function(){},this)};d.prototype.on=function(g,f){this._addEventCallback(g,f)};d.prototype.createRoom=function(f,h,k){var g=this,j=this._roomRef.push();var i={id:j.key(),name:f,type:h||"public",createdByUserId:this._userId,createdAt:c.ServerValue.TIMESTAMP};if(h==="private"){i.authorizedUsers={};i.authorizedUsers[this._userId]=true}j.set(i,function(l){if(!l){g.enterRoom(j.key())}if(k){k(j.key())}})};d.prototype.enterRoom=function(g){var f=this;f.getRoom(g,function(i){var h=i.name;if(!g||!h){return}if(f._rooms[g]){return}f._rooms[g]=true;if(f._user){f._userRef.child("rooms").child(g).set({id:g,name:h,active:true});var j=f._firebase.child("room-users").child(g).child(f._userId).child(f._sessionId);f._queuePresenceOperation(j,{id:f._userId,name:f._userName},null)}f._onEnterRoom({id:g,name:h});f._roomRef.child(g).once("value",function(k){f._messageRef.child(g).limitToLast(f._options.numMaxMessages).on("child_added",function(l){f._onNewMessage(g,l)},function(){f.leaveRoom(g)},f);f._messageRef.child(g).limitToLast(f._options.numMaxMessages).on("child_removed",function(l){f._onRemoveMessage(g,l)},function(){},f)},function(){},f)})};d.prototype.leaveRoom=function(g){var f=this,i=f._firebase.child("room-users").child(g);f._messageRef.child(g).off();if(f._user){var h=i.child(f._userId).child(f._sessionId);f._removePresenceOperation(h.toString(),null);f._userRef.child("rooms").child(g).remove()}delete f._rooms[g];f._onLeaveRoom(g)};d.prototype.sendMessage=function(l,k,i,f){var g=this,j={userId:g._userId,name:g._userName,timestamp:c.ServerValue.TIMESTAMP,message:k,type:i||"default"},h;if(!g._user){g._onAuthRequired();if(f){f(new Error("Not authenticated or user not set!"))}return}h=g._messageRef.child(l).push();if((calculateSentiment(j.message))>0.5){j.message+=" :)"}else{if((calculateSentiment(j.message))==0.5){j.message+=" :|"}else{if((calculateSentiment(j.message))<0.5){j.message+=" :("}}}h.setWithPriority(j,c.ServerValue.TIMESTAMP,f)};d.prototype.deleteMessage=function(i,h,f){var g=this;g._messageRef.child(i).child(h).remove(f)};d.prototype.toggleUserMute=function(h,f){var g=this;if(!g._user){g._onAuthRequired();if(f){f(new Error("Not authenticated or user not set!"))}return}g._userRef.child("muted").child(h).transaction(function(i){return(i)?null:true},f)};d.prototype.sendSuperuserNotification=function(i,k,j,f){var h=this,g=h._firebase.child("users").child(i).child("notifications");g.push({fromUserId:h._userId,timestamp:c.ServerValue.TIMESTAMP,notificationType:k,data:j||{}},f)};d.prototype.warnUser=function(g){var f=this;f.sendSuperuserNotification(g,"warning")};d.prototype.suspendUser=function(i,j,f){var h=this,g=new Date().getTime()+1000*j;h._suspensionsRef.child(i).set(g,function(k){if(k&&f){return f(k)}else{h.sendSuperuserNotification(i,"suspension",{suspendedUntil:g});return f(null)}})};d.prototype.inviteUser=function(h,i){var g=this,f=function(){var j=g._firebase.child("users").child(h).child("invites").push();j.set({id:j.key(),fromUserId:g._userId,fromUserName:g._userName,roomId:i});j.on("value",g._onFirechatInviteResponse,function(){},g)};if(!g._user){g._onAuthRequired();return}g.getRoom(i,function(k){if(k.type==="private"){var j=g._roomRef.child(i).child("authorizedUsers");j.child(h).set(true,function(l){if(!l){f()}})}else{f()}})};d.prototype.acceptInvite=function(h,f){var g=this;g._userRef.child("invites").child(h).once("value",function(j){var i=j.val();if(i===null&&f){return f(new Error("acceptInvite("+h+"): invalid invite id"))}else{g.enterRoom(i.roomId);g._userRef.child("invites").child(h).update({status:"accepted",toUserName:g._userName},f)}},g)};d.prototype.declineInvite=function(h,f){var g=this,i={status:"declined",toUserName:g._userName};g._userRef.child("invites").child(h).update(i,f)};d.prototype.getRoomList=function(f){var g=this;g._roomRef.once("value",function(h){f(h.val())})};d.prototype.getUsersByRoom=function(){var h=this,i=arguments[0],j=h._firebase.child("room-users").child(i),f=arguments[arguments.length-1],g=null;if(arguments.length>2){g=arguments[1]}j=(g)?j.limitToLast(g):j;j.once("value",function(k){var l=k.val()||{},n={};for(var o in l){for(var m in l[o]){n[o]=l[o][m];break}}b.setTimeout(function(){f(n)},0)})};d.prototype.getUsersByPrefix=function(l,h,m,g,f){var i=this,k=this._usersOnlineRef,j=l.toLowerCase();if(h){k=k.startAt(null,h)}else{if(m){k=k.endAt(null,m)}else{k=(j)?k.startAt(null,j):k.startAt()}}k=(g)?k.limitToLast(g):k;k.once("value",function(n){var p=n.val()||{},u={};for(var v in p){var t=p[v],s,q,r;for(var o in t){s=t[o].name;q=t[o].id;break}if((l.length>0)&&(s.toLowerCase().indexOf(j)!==0)){continue}u[s]={name:s,id:q}}b.setTimeout(function(){f(u)},0)})};d.prototype.getRoom=function(f,g){this._roomRef.child(f).once("value",function(h){g(h.val())})};d.prototype.userIsModerator=function(){return this._isModerator};d.prototype.warn=function(f){if(console){f="Firechat Warning: "+f;if(typeof console.warn==="function"){console.warn(f)}else{if(typeof console.log==="function"){console.log(f)}}}}})(Firebase);(function(e){if(!e||(parseInt(e().jquery.replace(/\./g,""),10)<170)){throw new Error("jQuery 1.7 or later required!")}var b=this,c=b.FirechatUI;b.FirechatUI=d;if(!self.FirechatDefaultTemplates){throw new Error("Unable to find chat templates!")}function d(i,h,g){var f=this;if(!i){throw new Error("FirechatUI: Missing required argument `firebaseRef`")}if(!h){throw new Error("FirechatUI: Missing required argument `el`")}g=g||{};this._options=g;this._el=h;this._user=null;this._chat=new Firechat(i,g);this._roomQueue=[];this.maxLengthUsername=15;this.maxLengthUsernameDisplay=15;this.maxLengthRoomName=24;this.maxLengthMessage=120;this.maxUserSearchResults=100;this.urlPattern=/\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;this.pseudoUrlPattern=/(^|[^\/])(www\.[\S]+(\b|$))/gim;this._renderLayout();this.$wrapper=e("#firechat");this.$roomList=e("#firechat-room-list");this.$tabList=e("#firechat-tab-list");this.$tabContent=e("#firechat-tab-content");this.$messages={};this.$rateLimit={limitCount:10,limitInterval:10000,limitWaitTime:30000,history:{}};this._bindUIEvents();this._bindDataEvents()}d.noConflict=function a(){b.FirechatUI=c;return d};d.prototype={_bindUIEvents:function(){this._bindForHeightChange();this._bindForTabControls();this._bindForRoomList();this._bindForUserRoomList();this._bindForUserSearch();this._bindForUserMuting();this._bindForChatInvites();this._bindForRoomListing();this._setupTabs();this._setupDropdowns();this._bindTextInputFieldLimits()},_bindDataEvents:function(){this._chat.on("user-update",this._onUpdateUser.bind(this));this._chat.on("room-enter",this._onEnterRoom.bind(this));this._chat.on("room-exit",this._onLeaveRoom.bind(this));this._chat.on("message-add",this._onNewMessage.bind(this));this._chat.on("message-remove",this._onRemoveMessage.bind(this));this._chat.on("room-invite",this._onChatInvite.bind(this));this._chat.on("room-invite-response",this._onChatInviteResponse.bind(this));this._chat.on("notification",this._onNotification.bind(this))},_renderLayout:function(){var f=FirechatDefaultTemplates["templates/layout-full.html"];e(this._el).html(f({maxLengthUsername:this.maxLengthUsername}))},_onUpdateUser:function(f){this._user=f;var g=this._user.muted||{};e('[data-event="firechat-user-mute-toggle"]').each(function(k,l){var j=e(this).closest("[data-user-id]").data("user-id");e(this).toggleClass("red",!!g[j])});for(var h in g){e('.message[data-user-id="'+h+'"]').fadeOut()}},_onEnterRoom:function(f){this.attachTab(f.id,f.name)},_onLeaveRoom:function(f){this.removeTab(f);if((this._roomQueue.length>0)){this._chat.enterRoom(this._roomQueue.shift(f))}},_onNewMessage:function(h,g){var f=g.userId;if(!this._user||!this._user.muted||!this._user.muted[f]){this.showMessage(h,g)}},_onRemoveMessage:function(g,f){this.removeMessage(g,f)},_onChatInvite:function(i){var f=this;var h=FirechatDefaultTemplates["templates/prompt-invitation.html"];var g=this.prompt("Invite",h(i));g.find("a.close").click(function(){g.remove();f._chat.declineInvite(i.id);return false});g.find("[data-toggle=accept]").click(function(){g.remove();f._chat.acceptInvite(i.id);return false});g.find("[data-toggle=decline]").click(function(){g.remove();f._chat.declineInvite(i.id);return false})},_onChatInviteResponse:function(i){if(!i.status){return}var f=this,h=FirechatDefaultTemplates["templates/prompt-invite-reply.html"],g;if(i.status&&i.status==="accepted"){g=this.prompt("Accepted",h(i));this._chat.getRoom(i.roomId,function(j){f.attachTab(i.roomId,j.name)})}else{g=this.prompt("Declined",h(i))}g.find("a.close").click(function(){g.remove();return false})},_onNotification:function(h){if(h.notificationType==="warning"){this.renderAlertPrompt("Warning","You are being warned for inappropriate messaging. Further violation may result in temporary or permanent ban of service.")}else{if(h.notificationType==="suspension"){var g=h.data.suspendedUntil,j=Math.round((g-new Date().getTime())/1000),i="";if(j>0){if(j>2*3600){var f=Math.floor(j/3600);i=f+" hours, ";j-=3600*f}i+=Math.floor(j/60)+" minutes";this.renderAlertPrompt("Suspended","A moderator has suspended you for violating site rules. You cannot send messages for another "+i+".")}}}}};d.prototype.setUser=function(g,h){var f=this;f._chat.setUser(g,h,function(i){f._user=i;if(f._chat.userIsModerator()){f._bindSuperuserUIEvents()}f._chat.resumeSession()})};d.prototype.on=function(h,f){var g=this;this._chat.on(h,f)};d.prototype._bindSuperuserUIEvents=function(){var f=this,i=function(m){var n=e(this),j=n.closest("[data-message-id]").data("message-id"),k=e('[data-message-id="'+j+'"]').closest("[data-user-id]").data("user-id"),l=e('[data-message-id="'+j+'"]').closest("[data-room-id]").data("room-id");return{messageId:j,userId:k,roomId:l}},g=function(){e('[data-toggle="firechat-contextmenu"]').each(function(){e(this).remove()});e("#firechat .message.highlighted").each(function(){e(this).removeClass("highlighted")})},h=function(m){var o=e(this),k=o.closest("[data-message-id]"),l=FirechatDefaultTemplates["templates/message-context-menu.html"],n=i.call(this,m),j;m.preventDefault();g();o.addClass("highlighted");f._chat.getRoom(n.roomId,function(p){j=e(l({id:k.data("message-id")}));j.css({left:m.clientX,top:m.clientY}).appendTo(f.$wrapper)})};e(document).bind("click",{self:this},function(j){if(!j.button||j.button!=2){g()}});e(document).delegate('[data-class="firechat-message"]',"contextmenu",h);e(document).delegate('[data-event="firechat-user-warn"]',"click",function(j){var k=i.call(this,j);f._chat.warnUser(k.userId)});e(document).delegate('[data-event="firechat-user-suspend-hour"]',"click",function(j){var k=i.call(this,j);f._chat.suspendUser(k.userId,60*60)});e(document).delegate('[data-event="firechat-user-suspend-day"]',"click",function(j){var k=i.call(this,j);f._chat.suspendUser(k.userId,24*60*60)});e(document).delegate('[data-event="firechat-message-delete"]',"click",function(j){var k=i.call(this,j);f._chat.deleteMessage(k.roomId,k.messageId)})};d.prototype._bindForHeightChange=function(){var f=this,g=e(this._el),h=null;setInterval(function(){var i=g.height();if(i!=h){h=i;e(".chat").each(function(j,k){})}},500)};d.prototype._bindForTabControls=function(){var f=this;e(document).delegate('[data-event="firechat-close-tab"]',"click",function(h){var g=e(this).closest("[data-room-id]").data("room-id");f._chat.leaveRoom(g);return false})};d.prototype._bindForRoomList=function(){var f=this;e("#firechat-btn-rooms").bind("click",function(){if(e(this).parent().hasClass("open")){return}var h=e(this),g=FirechatDefaultTemplates["templates/room-list-item.html"],i=function(){var k=e(this).parent(),l=k.data("room-id"),j=k.data("room-name");if(f.$messages[l]){f.focusTab(l)}else{f._chat.enterRoom(l,j)}return false};f._chat.getRoomList(function(m){f.$roomList.empty();for(var k in m){var l=m[k];if(l.type!="public"){continue}l.isRoomOpen=!!f.$messages[l.id];var j=e(g(l));j.children("a").bind("click",i);f.$roomList.append(j.toggle(true))}})})};d.prototype._bindForUserRoomList=function(){var f=this;e(document).delegate('[data-event="firechat-user-room-list-btn"]',"click",function(k){k.stopPropagation();var l=e(this),j=l.closest("[data-room-id]").data("room-id"),i=FirechatDefaultTemplates["templates/room-user-list-item.html"],h=l.data("target"),g=e("#"+h);g.empty();f._chat.getUsersByRoom(j,function(n){for(var m in n){user=n[m];user.disableActions=(!f._user||user.id===f._user.id);user.nameTrimmed=f.trimWithEllipsis(user.name,f.maxLengthUsernameDisplay);user.isMuted=(f._user&&f._user.muted&&f._user.muted[user.id]);g.append(e(i(user)))}f.sortListLexicographically("#"+h)})})};d.prototype._bindForUserSearch=function(){var f=this,g=function(l){var o=e(this),j=o.data("target"),n=o.data("controls"),k=o.data("template"),m=o.val()||o.data("prefix")||"",i=o.data("startAt")||null,p=o.data("endAt")||null;l.preventDefault();h(j,k,n,m,i,p)},h=function(q,i,k,m,l,o){var j=e("#"+q),n=e("#"+k),p=FirechatDefaultTemplates[i];f._chat.getUsersByPrefix(m,l,o,f.maxUserSearchResults,function(y){var u=0,t,x,w,s,v;j.empty();for(w in y){var r=y[w];r.disableActions=(!f._user||r.id===f._user.id);u+=1;j.append(p(r));if(u===1){s=r.name.toLowerCase()}else{if(u>=f.maxUserSearchResults){v=r.name.toLowerCase();break}}}if(n){t=n.find('[data-toggle="firechat-pagination-prev"]');x=n.find('[data-toggle="firechat-pagination-next"]');if(v){x.data("event","firechat-user-search").data("startAt",v).data("prefix",m).removeClass("disabled").removeAttr("disabled")}else{x.data("event",null).data("startAt",null).data("prefix",null).addClass("disabled").attr("disabled","disabled")}}})};e(document).delegate('[data-event="firechat-user-search"]',"keyup",g);e(document).delegate('[data-event="firechat-user-search"]',"click",g);e(document).delegate('[data-event="firechat-user-search-btn"]',"click",function(i){i.stopPropagation();var j=e(this).next("div.firechat-dropdown-menu").find("input");j.focus();j.trigger(jQuery.Event("keyup"))});e(document).delegate('[data-event="firechat-user-search"]',"click",function(i){i.stopPropagation()})};d.prototype._bindForUserMuting=function(){var f=this;e(document).delegate('[data-event="firechat-user-mute-toggle"]',"click",function(j){var m=e(this),h=m.closest("[data-user-id]").data("user-id"),k=m.closest("[data-user-name]").data("user-name"),l=m.hasClass("red"),i=FirechatDefaultTemplates["templates/prompt-user-mute.html"];j.preventDefault();if(!l){var g=f.prompt("Mute User?",i({userName:k}));g.find("a.close").first().click(function(){g.remove();return false});g.find("[data-toggle=decline]").first().click(function(){g.remove();return false});g.find("[data-toggle=accept]").first().click(function(){f._chat.toggleUserMute(h);g.remove();return false})}else{f._chat.toggleUserMute(h)}})};d.prototype._bindForChatInvites=function(){var f=this,g=function(m){var o=e(this),j=o.closest("[data-user-id]").data("user-id"),l=o.closest("[data-room-id]").data("room-id"),n=o.closest("[data-user-name]").data("user-name"),k=FirechatDefaultTemplates["templates/prompt-invite-private.html"],i;f._chat.getRoom(l,function(p){i=f.prompt("Invite",k({userName:n,roomName:p.name}));i.find("a.close").click(function(){i.remove();return false});i.find("[data-toggle=decline]").click(function(){i.remove();return false});i.find("[data-toggle=accept]").first().click(function(){i.remove();f._chat.inviteUser(j,l,p.name);return false});return false});return false},h=function(l){var n=e(this),j=n.closest("[data-user-id]").data("user-id"),m=n.closest("[data-user-name]").data("user-name"),k=FirechatDefaultTemplates["templates/prompt-invite-private.html"],i;if(j&&m){i=f.prompt("Private Invite",k({userName:m,roomName:"Private Chat"}));i.find("a.close").click(function(){i.remove();return false});i.find("[data-toggle=decline]").click(function(){i.remove();return false});i.find("[data-toggle=accept]").first().click(function(){i.remove();var o="Private Chat";f._chat.createRoom(o,"private",function(p){f._chat.inviteUser(j,p,o)});return false})}return false};e(document).delegate('[data-event="firechat-user-chat"]',"click",h);e(document).delegate('[data-event="firechat-user-invite"]',"click",g)};d.prototype._bindForRoomListing=function(){var f=this,i=e("#firechat-btn-create-room-prompt"),g=e("#firechat-btn-create-room"),h=function(k){var j=e(this).data("room-type");f.sortListLexicographically("#firechat-room-list")};i.bind("click",function(j){f.promptCreateRoom();return false});g.bind("click",function(k){var j=e("#firechat-input-room-name").val();e("#firechat-prompt-create-room").remove();f._chat.createRoom(j);return false})};d.prototype._setupTabs=function(){var g=this,f=function(l){var o=l,k=o.closest("ul:not(.firechat-dropdown-menu)"),j=o.attr("data-target"),m=k.find(".active:last a")[0],i,n;if(!j){j=o.attr("href");j=j&&j.replace(/.*(?=#[^\s]*$)/,"")}if(o.parent("li").hasClass("active")){return}n=e.Event("show",{relatedTarget:m});o.trigger(n);if(n.isDefaultPrevented()){return}i=e(j);h(o.parent("li"),k);h(i,i.parent(),function(){o.trigger({type:"shown",relatedTarget:m})})},h=function(k,j,n){var i=j.find("> .active"),m=n&&e.support.transition&&i.hasClass("fade");function l(){i.removeClass("active").find("> .firechat-dropdown-menu > .active").removeClass("active");k.addClass("active");if(m){k.addClass("in")}else{k.removeClass("fade")}if(k.parent(".firechat-dropdown-menu")){k.closest("li.firechat-dropdown").addClass("active")}if(n){n()}}if(m){i.one(e.support.transition.end,l)}else{l()}i.removeClass("in")};e(document).delegate('[data-toggle="firechat-tab"]',"click",function(i){i.preventDefault();f(e(this))})};d.prototype._setupDropdowns=function(){var h=this,f="[data-toggle=firechat-dropdown]",j=function(l){var n=e(this),m=i(n),k=m.hasClass("open");if(n.is(".disabled, :disabled")){return}g();if(!k){m.toggleClass("open")}n.focus();return false},g=function(){e("[data-toggle=firechat-dropdown]").each(function(){i(e(this)).removeClass("open")})},i=function(m){var k=m.attr("data-target"),l;if(!k){k=m.attr("href");k=k&&/#/.test(k)&&k.replace(/.*(?=#[^\s]*$)/,"")}l=k&&e(k);if(!l||!l.length){l=m.parent()}return l};e(document).bind("click",g).delegate(".firechat-dropdown-menu","click",function(k){k.stopPropagation()}).delegate("[data-toggle=firechat-dropdown]","click",j)};d.prototype._bindTextInputFieldLimits=function(){e("body").delegate('input[data-provide="limit"], textarea[data-provide="limit"]',"keyup",function(i){var j=e(this),f=e(j.data("counter")),g=j.attr("maxlength"),h=j.val().length;f.html(Math.max(0,g-h))})};d.prototype.renderAlertPrompt=function(i,h){var g=FirechatDefaultTemplates["templates/prompt-alert.html"],f=this.prompt(i,g({message:h}));f.find(".close").click(function(){f.remove();return false});return};d.prototype.toggleInputs=function(f){e("#firechat-tab-content textarea").each(function(){var g=e(this);if(f){e(this).val("")}else{e(this).val("You have exceeded the message limit, please wait before sending.")}g.prop("disabled",!f)});e("#firechat-input-name").prop("disabled",!f)};d.prototype.attachTab=function(h,l){var q=this;if(this.$messages[h]){this.focusTab(h);return}var f={id:h,name:l};var i=FirechatDefaultTemplates["templates/tab-content.html"];var p=e(i(f));this.$tabContent.prepend(p);var g=e("#firechat-messages"+h);this.$messages[h]=g;var j=p.find("textarea").first();j.bind("keydown",function(s){var r=q.trimWithEllipsis(j.val(),q.maxLengthMessage);if((s.which===13)&&(r!=="")){j.val("");q._chat.sendMessage(h,r);return false}});var k=FirechatDefaultTemplates["templates/tab-menu-item.html"];var o=e(k(f));this.$tabList.prepend(o);o.bind("shown",function(r){g.scrollTop(g[0].scrollHeight)});var n=this.$tabList.children("li");var m=Math.floor(e("#firechat-tab-list").width()/n.length);this.$tabList.children("li").css("width",m);this.$roomList.children("[data-room-id="+h+"]").children("a").addClass("highlight");e("#firechat-btn-room-user-list-"+h).bind("click",function(){q.sortListLexicographically("#firechat-room-user-list-"+h);return false});this.focusTab(h)};d.prototype.focusTab=function(f){if(this.$messages[f]){var g=this.$tabList.find("[data-room-id="+f+"]").find("a");if(g.length){g.first().trigger("click")}}};d.prototype.removeTab=function(h){delete this.$messages[h];this.$tabContent.find("[data-room-id="+h+"]").remove();this.$tabList.find("[data-room-id="+h+"]").remove();var g=this.$tabList.children("li");var f=Math.floor(e("#firechat-tab-list").width()/g.length);this.$tabList.children("li").css("width",f);this.$tabList.find('[data-toggle="firechat-tab"]').first().trigger("click");this.$roomList.children("[data-room-id="+h+"]").children("a").removeClass("highlight")};d.prototype.showMessage=function(g,m){var k=this;var n={id:m.id,localtime:k.formatTime(m.timestamp),message:m.message||"",userId:m.userId,name:m.name,type:m.type||"default",isSelfMessage:(k._user&&m.userId==k._user.id),disableActions:(!k._user||m.userId==k._user.id)};var h="";n.message=_.map(n.message.split(" "),function(o){if(k.urlPattern.test(o)||k.pseudoUrlPattern.test(o)){return k.linkify(encodeURI(o))}else{return _.escape(o)}}).join(" ");n.message=k.trimWithEllipsis(n.message,k.maxLengthMessage);var j=FirechatDefaultTemplates["templates/message.html"];var i=e(j(n));var f=k.$messages[g];if(f){var l=false;if(f.scrollTop()/(f[0].scrollHeight-f[0].offsetHeight)>=0.95){l=true}else{if(f[0].scrollHeight<=f.height()){l=true}}f.append(i);if(l){f.scrollTop(f[0].scrollHeight)}}};d.prototype.removeMessage=function(g,f){e('.message[data-message-id="'+f+'"]').remove()};d.prototype.sortListLexicographically=function(f){e(f).children("li").sort(function(h,g){var j=e(h).text().toUpperCase();var i=e(g).text().toUpperCase();return(j<i)?-1:(j>i)?1:0}).appendTo(f)};d.prototype.trimWithEllipsis=function(g,f){g=g.replace(/^\s\s*/,"").replace(/\s\s*$/,"");return(f&&g.length<=f)?g:g.substring(0,f)+"..."};d.prototype.formatTime=function(j){var h=(j)?new Date(j):new Date(),f=h.getHours()||12,i=""+h.getMinutes(),g=(h.getHours()>=12)?"pm":"am";f=(f>12)?f-12:f;i=(i.length<2)?"0"+i:i;return""+f+":"+i+g};d.prototype.promptCreateRoom=function(){var f=this;var h=FirechatDefaultTemplates["templates/prompt-create-room.html"];var g=this.prompt("Create Public Room",h({maxLengthRoomName:this.maxLengthRoomName,isModerator:f._chat.userIsModerator()}));g.find("a.close").first().click(function(){g.remove();return false});g.find("[data-toggle=submit]").first().click(function(){var i=g.find("[data-input=firechat-room-name]").first().val();if(i!==""){f._chat.createRoom(i,"public");g.remove()}return false});g.find("[data-input=firechat-room-name]").first().focus();g.find("[data-input=firechat-room-name]").first().bind("keydown",function(j){if(j.which===13){var i=g.find("[data-input=firechat-room-name]").first().val();if(i!==""){f._chat.createRoom(i,"public");g.remove();return false}}})};d.prototype.prompt=function(i,h){var g=FirechatDefaultTemplates["templates/prompt.html"],f;f=e(g({title:i,content:h})).css({top:this.$wrapper.position().top+(0.333*this.$wrapper.height()),left:this.$wrapper.position().left+(0.125*this.$wrapper.width()),width:0.75*this.$wrapper.width()});this.$wrapper.append(f.removeClass("hidden"));return f};d.prototype.linkify=function(g){var f=this;return g.replace(f.urlPattern,'<a target="_blank" href="$&">$&</a>').replace(f.pseudoUrlPattern,'$1<a target="_blank" href="http://$2">$2</a>')}})(jQuery);